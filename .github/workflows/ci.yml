name: "CI"

env:
  FOUNDRY_PROFILE: "ci"

permissions:
  contents: write  # ✅ required for peaceiris/actions-gh-pages to push

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - "main"

jobs:
  build:
    runs-on: ubuntu-latest
    # Run on direct pushes to main, and on PRs targeting main (regardless of source branch name)
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.base_ref == 'main')
    steps:
      - name: "Check out the repo"
        uses: actions/checkout@v4

      - name: "Install Foundry"
        uses: foundry-rs/foundry-toolchain@v1

      - name: "Install Bun"
        uses: oven-sh/setup-bun@v1

      - name: "Install the Node.js dependencies"
        run: bun install

      - name: "Check formatting"
        run: forge fmt --check

      - name: "Build the contracts and print their size"
        run: forge build --sizes

      - name: "Add build summary"
        run: |
          echo "## Build result" >> $GITHUB_STEP_SUMMARY
          echo "✅ Passed" >> $GITHUB_STEP_SUMMARY

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: "Check out the repo"
        uses: actions/checkout@v4

      - name: "Install Foundry"
        uses: foundry-rs/foundry-toolchain@v1

      - name: "Install Bun"
        uses: oven-sh/setup-bun@v1

      - name: "Install the Node.js dependencies"
        run: bun install

      - name: "Show the Foundry config"
        run: forge config

      - name: "Generate weekly fuzz seed"
        run: echo "FOUNDRY_FUZZ_SEED=$(( $EPOCHSECONDS - $EPOCHSECONDS % 604800 ))" >> $GITHUB_ENV

      - name: "Run the tests"
        run: forge test

  coverage:
    needs: ["test"]
    runs-on: "ubuntu-latest"
    if: github.event_name == 'push' && github.base_ref == 'main'
    steps:
      - name: "Check out the repo"
        uses: "actions/checkout@v4"

      - name: "Install Foundry"
        uses: "foundry-rs/foundry-toolchain@v1"

      - name: "Install Bun"
        uses: "oven-sh/setup-bun@v1"

      - name: "Install the Node.js dependencies"
        run: "bun install"

      - name: "Create coverage directory"
        run: "mkdir -p coverage"

      - name: "Forge coverage"
        run: "bun run test:coverage:report"
      
      - name: "Add coverage summary"
        run: |
          echo "## Coverage result" >> $GITHUB_STEP_SUMMARY
          echo "✅ Passed" >> $GITHUB_STEP_SUMMARY

      - name: "Create public badge"
        run: "bun run badge"

      - name: "Build github pages"
        uses: "peaceiris/actions-gh-pages@v4"
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage
          destination_dir: ./coverage

      